version: '3.1'

services:
  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:18.0.0
    command: start --hostname=@%@keycloak/server/sso/fqdn@%@ --http-enabled=true --proxy edge
    ## For --proxy edge see https://www.keycloak.org/server/reverseproxy
    restart: unless-stopped
    environment:
      KC_DB: "postgres"
      KC_DB_URL_HOST: postgres
      KC_DB_USERNAME: keycloak
      KC_HTTPS_KEY_STORE_PASSWORD: univention
      KEYCLOAK_ADMIN: @%@keycloak/admin/user@%@
      KEYCLOAK_ADMIN_PASSWORD: @!@
import os
pwdfile="/etc/keycloak.secret"
with open(pwdfile, 'r') as fd:
    print(fd.read().strip())@!@
      KC_LOG_LEVEL: @%@keycloak/log/level@%@
      PROXY_ADDRESS_FORWARDING: "true"
      JAVA_OPTS: "@%@keycloak/java/opts@%@"
      X509_CA_BUNDLE: "/ca-certificates.crt"
    volumes:
      - /etc/ssl/certs/ca-certificates.crt:/ca-certificates.crt:ro
      - /var/lib/univention-appcenter/apps/keycloak/conf/UCS:/opt/keycloak/themes/UCS
      #- /var/lib/univention-appcenter/apps/keycloak/data/development:/opt/jboss/keycloak/standalone/deployments/
    ports:
      # does not work, see https://forge.univention.org/bugzilla/show_bug.cgi?id=53878
      # - 127.0.0.1:8180:8080
      - 8180:8080
    healthcheck:
      test: curl https://@%@keycloak/url/prefix@%@.@%@hostname@%@.@%@domainname@%@/ -k -s -f -o /dev/null || exit 1
      interval: "2s"
      timeout: "3s"
      retries: 20
