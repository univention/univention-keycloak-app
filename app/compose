version: '3.1'

services:
  keycloak:
    container_name: keycloak
    image: docker.software-univention.de/keycloak-adhoc:19.0.1-ucs2
    command: start --optimized --hostname=@%@keycloak/server/sso/fqdn@%@ --http-enabled=true --proxy=edge --cache=cache-ispn-jdbc-ping.xml
    ## For --proxy=edge see https://www.keycloak.org/server/reverseproxy
    ## For --hostname   see https://www.keycloak.org/server/hostname
    restart: unless-stopped
    environment:
      KC_HTTP_PORT: "8180"
      KC_DB_URL_HOST: postgres
      ## This must be changed to the IP of the postgres machine (e.g. 10.200.92.100), hostname may not be resolve from inside the container
      KC_DB_USERNAME: keycloak
      ## KC_DB_PASSWORD is passed by the appcenter, but it will be the local keycloak, it needs to be the one from the remote database
      ## JGROUPS_DISCOVERY_EXTERNAL_IP=10.200.92.25
      ## JGROUPS_DISCOVERY_EXTERNAL_IP= should be the ip of the local machine
      KC_HTTPS_KEY_STORE_PASSWORD: univention
      KEYCLOAK_ADMIN: @%@keycloak/admin/user@%@
      KEYCLOAK_ADMIN_PASSWORD: @!@
import os
pwdfile="/etc/keycloak.secret"
with open(pwdfile, 'r') as fd:
    print(fd.read().strip())@!@
      KC_LOG_LEVEL: @%@keycloak/log/level@%@
      PROXY_ADDRESS_FORWARDING: "true"
      JAVA_OPTS: "@%@keycloak/java/opts@%@"
      X509_CA_BUNDLE: "/ca-certificates.crt"
    volumes:
      - /etc/ssl/certs/ca-certificates.crt:/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:ro
      - /var/lib/univention-appcenter/apps/keycloak/conf/UCS:/opt/keycloak/themes/UCS
      #- /var/lib/univention-appcenter/apps/keycloak/data/development:/opt/jboss/keycloak/standalone/deployments/
    ports:
      # does not work, see https://forge.univention.org/bugzilla/show_bug.cgi?id=53878
      # - 127.0.0.1:8180:8080
      - 8180:8180
      - 7600:7600 
    healthcheck:
      test: curl http://127.0.0.1:8180/ -k -s -f -o /dev/null || exit 1
      interval: "2s"
      timeout: "3s"
      retries: 20
