version: '3.1'

services:

  postgres:
    container_name: postgres
    image: postgres:9.6.23
    restart: unless-stopped
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - /var/lib/univention-appcenter/apps/keycloak/data/postgres-data:/var/lib/postgresql/data

  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:17.0.0
    command: start-dev --http-enabled=true --proxy edge
    ## For --proxy edge see https://www.keycloak.org/server/reverseproxy
    restart: unless-stopped
    environment:
      KC_DB_URL_HOST: postgres
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HTTPS_KEY_STORE_PASSWORD: univention
      KEYCLOAK_ADMIN: @%@keycloak/admin/user@%@
      KEYCLOAK_ADMIN_PASSWORD: @!@
import os
pwdfile="/etc/keycloak.secret"
with open(pwdfile, 'r') as fd:
    print(fd.read().strip())@!@
      KEYCLOAK_LOGLEVEL: @%@keycloak/log/level@%@
      PROXY_ADDRESS_FORWARDING: "true"
      JAVA_OPTS: "@%@keycloak/java/opts@%@"
      X509_CA_BUNDLE: "/ca-certificates.crt"
    volumes:
      - /etc/ssl/certs/ca-certificates.crt:/ca-certificates.crt:ro
      #- /var/lib/univention-appcenter/apps/keycloak/data/development:/opt/jboss/keycloak/standalone/deployments/
    ports:
      # does not work, see https://forge.univention.org/bugzilla/show_bug.cgi?id=53878
      # - 127.0.0.1:8080:8080
    - 8080:8080
    depends_on:
      - postgres