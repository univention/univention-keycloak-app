stages:
  - build
  - scan-released
  - scan-staged

check_staged_container:
  stage: scan-staged
  dependencies:
    - check_released_container
  image:
    name: gitregistry.knut.univention.de/univention/components/keycloak-app:latest
    entrypoint: [""]
  artifacts:
    paths: 
      - package-list-latest.txt
  script:
    - dpkg-query --showformat='${Package};${Version}\n' --show | sort > package-list-latest.txt


check_released_container:
  stage: scan-released
  image:
    name: docker.software-univention.de/keycloak-keycloak:${APP_VERSION}
    entrypoint: [""]
  artifacts:
    when: on_failure
    paths:
      - package-list-diff.txt
  script:
    - dpkg-query --showformat='${Package};${Version}\n' --show | sort > package-list-released.txt
    - echo "Packages to be updated:" > package-list-diff.txt
    - diff -u package-list-released.txt package-list-latest.txt >> package-list-diff.txt


