stages:
  - test
  - prepare
  - build
  - merge
  - production

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "webide"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_OPEN_MERGE_REQUESTS
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_PROTECTED == "true"

include:
  - project: univention/dist/docker-services
    file:
      - kaniko.yml
      - pre-commit.yml

variables:
  # version
  DOC_TARGET_VERSION: "22.0.3"

#pre-commit:
#  stage: test
#  extends: .pre-commit
#
#generate-config:
#  stage: prepare
#  image:
#    name: docker-registry.knut.univention.de/knut/deb-builder
#    entrypoint: [""]
#  script:
#    - .gitlab-ci/build-ci
#  artifacts:
#    paths:
#      - generated-config-doc.yml

#doc-pipeline:
#  stage: build
#  rules:
#    - changes:
#      - "docs/keycloak-app/**/*"
#      - "docs/keycloak-migration/**/*"
#  needs:
#    - job: generate-config
#  trigger:
#    include:
#      - artifact: generated-config-doc.yml
#        job: generate-config
#    strategy: depend
#    forward:
#      pipeline_variables: true

image_build:
  stage: build
  extends: .kaniko
  rules:
    - changes:
      - ad-hoc/**/*
      - dependencies/**/*
      - Dockerfile
      - files/**/*
      - univention-ldap-mapper/**/*
      - .gitlab-ci.yml
  variables:
    KANIKO_ARGS: --build-arg commit="$CI_COMMIT_SHA" --build-arg date="$CI_JOB_STARTED_AT" --cache=true --cache-repo=$CI_REGISTRY_IMAGE/cache

sbom:
  stage: build
  variables:
    IMAGE_SYFT: "${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/anchore/syft:v0.93.0-debug"
  cache:
    - key: "container-sbom-${CI_COMMIT_REF_SLUG}"
      paths:
        - "${CI_PROJECT_DIR}/sbom.cdx.json"
      policy: "push"
    - key: "container-build-${CI_COMMIT_REF_SLUG}"
      paths:
        - "${CI_PROJECT_DIR}/digest"
      policy: "pull"
  image:
    name: "${IMAGE_SYFT}"
    entrypoint: [""]
  needs:
    - "image_build"
  script:
    - "env"
    - "/syft --scope all-layers -o spdx-json ${IMAGE_TAG} > ${CI_PROJECT_DIR}/sbom.cdx.json"
    - "/syft --scope all-layers ${IMAGE_TAG}"

add-sbom:
  variables:
    IMAGE_COSIGN: "${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/bitnami/cosign:2.0.2"
  cache:
    - key: "container-sbom-${CI_COMMIT_REF_SLUG}"
      paths:
        - "${CI_PROJECT_DIR}/sbom.cdx.json"
      policy: "pull"
    - key: "container-build-${CI_COMMIT_REF_SLUG}"
      paths:
        - "${CI_PROJECT_DIR}/digest"
      policy: "pull"
  image:
    name: "${IMAGE_COSIGN}"
    entrypoint: [""]
  needs:
    - "sbom"
  script:
    - "cosign attach sbom --type=spdx --input-format=json --sbom=sbom.cdx.json ${IMAGE_TAG}"
  stage: "build"
